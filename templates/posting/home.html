{% extends "base.html" %}
{% load posting_tags %}

{% block title %}Tree Hole Yale{% endblock title %}

{% block floating_button %}
<!-- Old FAB removed -->
{% endblock floating_button %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
<!-- Data attribute for JavaScript -->
<div data-suggest-tags-url="{% url 'posting:suggest_tags' %}" style="display:none;"></div>
<div class="sticky-header">
    <!-- Search Bar -->
    <section class="search-section">
        <form method="get" action="{% url 'posting:home' %}" class="search-form">
            <div class="search-wrapper">
                <input type="text" name="q" placeholder="Search posts, classes, professors..."
                    value="{{ search_query }}" class="search-input" id="search-input">
                <button type="submit" class="search-button" aria-label="Search">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </button>
            </div>
            {% if active_tag %}
            <input type="hidden" name="tag" value="{{ active_tag }}">
            {% endif %}
            {% if sort == "popular" or sort == "trending" %}
            <input type="hidden" name="sort" value="{{ sort }}">
            {% endif %}
            {% if view_mode == "posts" %}
            <input type="hidden" name="view" value="posts">
            {% endif %}
            {% if search_query %}
            <a href="{% url 'posting:home' %}{% if active_tag %}?tag={{ active_tag }}{% endif %}{% if sort == 'popular' or sort == 'trending' %}{% if active_tag %}&{% else %}?{% endif %}sort={{ sort }}{% endif %}{% if view_mode == 'posts' %}{% if active_tag or sort == 'popular' or sort == 'trending' %}&{% else %}?{% endif %}view=posts{% endif %}"
                class="clear-search" aria-label="Clear search">
                ‚úï
            </a>
            {% endif %}
        </form>
    </section>
</div>

<!-- Tag Filter Chips - REMOVED as per user request -->

{% if active_tag == "pastclassreview" %}
<!-- Sub-filters for Past Class Reviews -->
<section class="sub-filter-section">
    <div class="sub-filter-bar">
        <span class="sub-filter-label">Filter by sentiment:</span>
        <div class="sub-filter-chips">
            <a href="{% url 'posting:home' %}?tag=pastclassreview{% if search_query %}&q={{ search_query|urlencode }}{% endif %}{% if sort == 'popular' or sort == 'trending' %}&sort={{ sort }}{% endif %}"
                class="sub-filter-chip {% if not sentiment_filter %}active{% endif %}">
                All Reviews
            </a>
            <a href="{% url 'posting:home' %}?tag=recommended{% if search_query %}&q={{ search_query|urlencode }}{% endif %}{% if sort == 'popular' or sort == 'trending' %}&sort={{ sort }}{% endif %}"
                class="sub-filter-chip recommended {% if sentiment_filter == 'recommended' %}active{% endif %}">
                Recommended
            </a>
            <a href="{% url 'posting:home' %}?tag=not-recommended{% if search_query %}&q={{ search_query|urlencode }}{% endif %}{% if sort == 'popular' or sort == 'trending' %}&sort={{ sort }}{% endif %}"
                class="sub-filter-chip not-recommended {% if sentiment_filter == 'not-recommended' %}active{% endif %}">
                Not Recommended
            </a>
            <a href="{% url 'posting:home' %}?tag=mixed-review{% if search_query %}&q={{ search_query|urlencode }}{% endif %}{% if sort == 'popular' or sort == 'trending' %}&sort={{ sort }}{% endif %}"
                class="sub-filter-chip mixed {% if sentiment_filter == 'mixed-review' %}active{% endif %}">
                Mixed
            </a>
        </div>
    </div>
    <p class="sub-filter-hint">Tip: Use the search bar to find reviews for a specific course (e.g., "MGT 809")</p>
</section>
{% endif %}

<!-- Post Creation Form (Always visible at top) -->
<div id="create-post-section">
    <section class="post-create-card">
        <div class="card-header">
            <!-- Avatar placeholder removed as per user request to delete 'v' (likely the placeholder) -->
            <button class="fake-input-wrapper"
                onclick="document.getElementById('post-form-content').style.display='block'">
                <span class="fake-input-title">Share Your Thought</span>
                <span class="fake-input-subtitle">What's on your mind?</span>
            </button>
        </div>
        <div id="post-form-content">
            {% if user.is_authenticated %}
            <form method="post" class="post-form" id="post-form">
                {% csrf_token %}

                <div class="form-field">
                    <label for="{{ form.title.id_for_label }}">{{ form.title.label }}</label>
                    {{ form.title }}
                    {% if form.title.errors %}
                    <div class="form-error">{{ form.title.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-field">
                    <label for="{{ form.body.id_for_label }}">{{ form.body.label }}</label>
                    {{ form.body }}
                    {% if form.body.errors %}
                    <div class="form-error">{{ form.body.errors }}</div>
                    {% endif %}
                    <div id="hashtag-preview" class="hashtag-preview" style="display: none;">
                        <span class="hashtag-preview-label">Detected tags:</span>
                        <span id="hashtag-list" class="hashtag-list"></span>
                    </div>
                    <p class="form-help">üí° Tip: Use #hashtag in your post to automatically add tags!</p>
                </div>

                <div class="form-field">
                    <label for="{{ form.tags_input.id_for_label }}">{{ form.tags_input.label }}</label>
                    {{ form.tags_input }}
                    {% if form.tags_input.errors %}
                    <div class="form-error">{{ form.tags_input.errors }}</div>
                    {% endif %}
                    {% if form.tags_input.help_text %}
                    <p class="form-help">{{ form.tags_input.help_text }}</p>
                    {% endif %}
                </div>

                <!-- Hidden original fields -->
                <div style="display:none;">
                    {{ form.is_anonymous }}
                    {{ form.post_as_identity }}
                </div>

                <div class="form-options">
                    <div class="identity-selector">
                        <label class="identity-option-label">Post as:</label>
                        <div class="identity-toggle-group">
                            <label class="identity-radio">
                                <input type="radio" name="identity_choice" value="anonymous" checked
                                    onchange="updateIdentityState(this.value)">
                                <span class="radio-label">Anonymous</span>
                            </label>
                            <label class="identity-radio">
                                <input type="radio" name="identity_choice" value="profile"
                                    onchange="updateIdentityState(this.value)">
                                <span class="radio-label">Profile Identity</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="submit-btn" id="submit-button">Post</button>
                </div>
            </form>
            {% else %}
            <p><a href="{% url 'auth_landing:login' %}">Log in with your Yale account</a> to post.</p>
            {% endif %}
        </div>
    </section>
</div>

<section id="posts-section" class="posts-feed">
    <div class="posts-header">
        <div>
            <h2 style="margin: 0 0 1.5rem 0;">
                {% if search_query %}
                Search Results
                {% elif sort == "trending" %}
                Trending Posts
                {% elif sort == "popular" %}
                Popular Posts
                {% else %}
                Recent Posts
                {% endif %}
            </h2>
            {% if search_query or active_tag %}
            <p class="results-count" role="status" aria-live="polite">
                Found {{ posts_count }} post{{ posts_count|pluralize }}
                {% if search_query %}matching "{{ search_query }}"{% endif %}
                {% if active_tag %}in {{ active_tag|title }}{% endif %}
            </p>
            {% endif %}
        </div>
        <div class="sort-controls">
            <a href="{% url 'posting:home' %}{% if active_tag %}?tag={{ active_tag }}{% endif %}{% if search_query %}{% if active_tag %}&{% else %}?{% endif %}q={{ search_query|urlencode }}{% endif %}"
                class="sort-button {% if sort == 'recent' %}active{% endif %}">
                Recent
            </a>
            <a href="{% url 'posting:home' %}?sort=trending{% if active_tag %}&tag={{ active_tag }}{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}"
                class="sort-button {% if sort == 'trending' %}active{% endif %}">
                Trending
            </a>
        </div>
    </div>

    {% if posts %}
    {% for post in posts %}
    <article class="post-card" data-post-id="{{ post.pk }}">
        <header class="post-header">
            <div class="post-meta-line">
                {% if post.is_anonymous %}
                <div class="post-avatar anonymous small">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <span class="post-author">Anonymous</span>
                <span class="meta-separator">‚Ä¢</span>
                <span class="post-time">{{ post.created_at|timesince }} ago</span>
                {% else %}
                <div class="post-avatar small">
                    {% if post.author.profile.avatar %}
                    <img src="{{ post.author.profile.avatar.url }}" alt="{{ post.author.profile.display_name }}"
                        class="avatar-img">
                    {% else %}
                    <div class="avatar-placeholder">{{
                        post.author.profile.display_name|first|default:post.author.username|first|upper }}</div>
                    {% endif %}
                </div>
                <span class="post-author">{{ post.author.profile.display_name|default:post.author.username }}</span>
                <span class="meta-separator">‚Ä¢</span>
                <span class="post-time">{{ post.created_at|timesince }} ago</span>
                {% endif %}
            </div>

            <!-- Header Actions (Vote + Reply + Flag) -->
            <div class="header-actions">
                <!-- Vote Section -->
                <div class="vote-section">
                    <button class="vote-button upvote-button {% if request.user in post.upvotes.all %}active{% endif %}"
                        onclick="handleVote('{{ post.pk }}', 'up')" aria-label="Upvote">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="18 15 12 9 6 15"></polyline>
                        </svg>
                    </button>
                    <span id="vote-count-{{ post.pk }}"
                        class="comment-net-votes {% if post.net_votes > 0 %}positive{% elif post.net_votes < 0 %}negative{% endif %}">
                        {{ post.net_votes }}
                    </span>
                    <button
                        class="vote-button downvote-button {% if request.user in post.downvotes.all %}active{% endif %}"
                        onclick="handleVote('{{ post.pk }}', 'down')" aria-label="Downvote">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                </div>

                <!-- Reply Button -->
                <button type="button" class="header-reply-button" onclick="togglePostComments('{{ post.id }}')"
                    title="Reply">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                        </path>
                    </svg>
                    <span class="reply-count">{{ post.comments.count }}</span>
                </button>

                <!-- Flag Action -->
                <form method="post" action="{% url 'posting:flag' post.id %}" class="flag-form"
                    onsubmit="return confirm('Flag this post as inappropriate?');">
                    {% csrf_token %}
                    <button type="submit" class="action-button flag-button" title="Flag as inappropriate">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                            <line x1="4" y1="22" x2="4" y2="15"></line>
                        </svg>
                    </button>
                </form>
            </div>
        </header>

        <h3 class="post-title">{{ post.title }}</h3>

        {% if post.show_crisis_resources %}
        <div class="crisis-resources-box">
            <strong>You're not alone.</strong> If you or someone you know needs support:
            <ul>
                <li>Yale Mental Health &amp; Counseling: <a href="tel:203-432-0290">203-432-0290</a> (24/7)</li>
                <li>Crisis Text Line: Text HOME to 741741</li>
                <li>988 Suicide &amp; Crisis Lifeline: Call or text 988</li>
            </ul>
        </div>
        {% endif %}
        <div class="post-body-content" data-collapsed="true">
            {{ post.body|linebreaks }}
        </div>
        <p class="post-tags">
            {% for tag in post.tags.all %}
            <span class="hashtag">#{{ tag.name }}</span>
            {% endfor %}
        </p>


        {# Comments Section - Hidden by default #}
        <div class="comments-wrapper" id="comments-wrapper-{{ post.pk }}" style="display: none;">
            {% include "posting/components/comments.html" with post=post user_comment_votes=user_comment_votes %}
        </div>
    </article>
    {% endfor %}

    <!-- Pagination Controls -->
    {% if posts.has_other_pages %}
    <div class="pagination">
        <span class="step-links">
            {% if posts.has_previous %}
            <a href="?page={{ posts.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if active_tag %}&tag={{ active_tag }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
                class="pagination-link">Previous</a>
            {% endif %}

            <div class="pagination-select-wrapper">
                <span class="pagination-label">Page</span>
                <select onchange="window.location.href=this.value" class="pagination-select">
                    {% for i in posts.paginator.page_range %}
                    <option
                        value="?page={{ i }}{% if search_query %}&q={{ search_query }}{% endif %}{% if active_tag %}&tag={{ active_tag }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
                        {% if posts.number == i %}selected{% endif %}>
                        {{ i }}
                    </option>
                    {% endfor %}
                </select>
                <span class="pagination-label">of {{ posts.paginator.num_pages }}</span>
            </div>

            {% if posts.has_next %}
            <a href="?page={{ posts.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if active_tag %}&tag={{ active_tag }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
                class="pagination-link">Next</a>
            {% endif %}
        </span>
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        {% if search_query %}
        <p class="empty-state-icon">üîç</p>
        <h3>No posts found</h3>
        <p>No posts match your search for "{{ search_query }}".</p>
        <a href="{% url 'posting:home' %}{% if active_tag %}?tag={{ active_tag }}{% endif %}"
            class="clear-filter-button">
            Clear search
        </a>
        {% elif active_tag %}
        <p class="empty-state-icon">üè∑Ô∏è</p>
        <h3>No posts in this category</h3>
        <p>Be the first to post in {{ active_tag|title }}!</p>
        {% else %}
        <p class="empty-state-icon">üìù</p>
        <h3>No posts yet</h3>
        <p>Be the first to share your thoughts!</p>
        {% endif %}
    </div>
    {% endif %}
</section>

<!-- Floating "Share Your Thought" Button (Visible on scroll) -->
<button id="fab-share-thought" class="fab-share-thought" onclick="openPostModal()">
    <span class="fab-icon">‚úçÔ∏è</span>
    <span class="fab-text">Share Your Thought</span>
</button>

<!-- Post Modal -->
<div id="post-modal" class="post-modal" style="display: none;">
    <div class="post-modal-content">
        <div class="modal-header">
            <h2>Create Post</h2>
            <button class="close-modal" onclick="closePostModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <!-- We will clone the form here via JS or just move it? 
                 Moving it might lose state. Let's just have a second form or move the form element.
                 Actually, moving the form element is safer to preserve the form logic. -->
            <div id="modal-form-container"></div>
        </div>
    </div>
</div>

{% endblock content %}
