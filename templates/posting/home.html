{% extends "base.html" %}
{% load posting_tags %}

{% block title %}Tree Hole Yale{% endblock title %}

{% block floating_button %}
<!-- Old FAB removed -->
{% endblock floating_button %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
<!-- Data attribute for JavaScript -->
<div data-suggest-tags-url="{% url 'posting:suggest_tags' %}" style="display:none;"></div>

<!-- In-Page Sticky Navigation Bar -->
<nav class="in-page-nav">
    <div class="in-page-nav-container">
        <a href="{% url 'posting:home' %}"
            class="in-page-nav-item {% if request.GET.view != 'create' %}active{% endif %}">
            Home
        </a>
        <a href="{% url 'posting:home' %}?view=create"
            class="in-page-nav-item {% if request.GET.view == 'create' %}active{% endif %}">
            Create Post
        </a>
    </div>
</nav>

<!-- Post Creation Form (visible on Create Post tab, hidden on Home but available for modal) -->
<div id="create-post-section" {% if request.GET.view != 'create' %}style="display:none;"{% endif %}>
    <section class="post-create-card">
        <div class="card-header">
            <button class="fake-input-wrapper"
                onclick="document.getElementById('post-form-content').style.display='block'">
                <span class="fake-input-title">Share Your Thought</span>
                <span class="fake-input-subtitle">What's on your mind?</span>
            </button>
        </div>
        <div id="post-form-content">
            {% if user.is_authenticated %}
            <form method="post" class="post-form" id="post-form">
                {% csrf_token %}

                <div class="form-field">
                    <label for="{{ form.title.id_for_label }}">{{ form.title.label }}</label>
                    {{ form.title }}
                    {% if form.title.errors %}
                    <div class="form-error">{{ form.title.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-field">
                    <label for="{{ form.body.id_for_label }}">{{ form.body.label }}</label>
                    {{ form.body }}
                    {% if form.body.errors %}
                    <div class="form-error">{{ form.body.errors }}</div>
                    {% endif %}
                    <div id="hashtag-preview" class="hashtag-preview" style="display: none;">
                        <span class="hashtag-preview-label">Detected tags:</span>
                        <span id="hashtag-list" class="hashtag-list"></span>
                    </div>
                    <p class="form-help">üí° Tip: Use #hashtag in your post to automatically add tags!</p>
                </div>

                <div class="form-field">
                    <label for="{{ form.tags_input.id_for_label }}">{{ form.tags_input.label }}</label>
                    {{ form.tags_input }}
                    {% if form.tags_input.errors %}
                    <div class="form-error">{{ form.tags_input.errors }}</div>
                    {% endif %}
                    {% if form.tags_input.help_text %}
                    <p class="form-help">{{ form.tags_input.help_text }}</p>
                    {% endif %}
                </div>

                <!-- Hidden original fields -->
                <div style="display:none;">
                    {{ form.is_anonymous }}
                    {{ form.post_as_identity }}
                </div>

                <div class="form-options">
                    <div class="identity-selector">
                        <label class="identity-option-label">Post as:</label>
                        <div class="identity-toggle-group">
                            <label class="identity-radio">
                                <input type="radio" name="identity_choice" value="anonymous" checked
                                    onchange="updateIdentityState(this.value)">
                                <span class="radio-label">Anonymous</span>
                            </label>
                            <label class="identity-radio">
                                <input type="radio" name="identity_choice" value="profile"
                                    onchange="updateIdentityState(this.value)">
                                <span class="radio-label">Profile Identity</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="submit-btn" id="submit-button">Post</button>
                </div>
            </form>
            {% else %}
            <p><a href="{% url 'auth_landing:login' %}">Log in with your Yale account</a> to post.</p>
            {% endif %}
        </div>
    </section>
</div>

{% if request.GET.view != 'create' %}
<section id="posts-section" class="posts-feed">
    <div class="posts-header">
        <div>
            <h2 style="margin: 0 0 1.5rem 0;">
                {% if search_query %}
                Search Results
                {% elif sort == "trending" %}
                Trending Posts
                {% elif sort == "popular" %}
                Popular Posts
                {% else %}
                Recent Posts
                {% endif %}
            </h2>
            {% if search_query or active_tag %}
            <p class="results-count" role="status" aria-live="polite">
                Found {{ posts_count }} post{{ posts_count|pluralize }}
                {% if search_query %}matching "{{ search_query }}"{% endif %}
                {% if active_tag %}in {{ active_tag|title }}{% endif %}
            </p>
            {% endif %}
        </div>
        <div class="sort-controls">
            <a href="{% url 'posting:home' %}{% if active_tag %}?tag={{ active_tag }}{% endif %}{% if search_query %}{% if active_tag %}&{% else %}?{% endif %}q={{ search_query|urlencode }}{% endif %}"
                class="sort-button {% if sort == 'recent' %}active{% endif %}">
                Recent
            </a>
            <a href="{% url 'posting:home' %}?sort=trending{% if active_tag %}&tag={{ active_tag }}{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}"
                class="sort-button {% if sort == 'trending' %}active{% endif %}">
                Trending
            </a>
        </div>
    </div>

    <!-- Tag Filter Dropdown -->
    <div class="tag-dropdown-wrapper">
        <button class="tag-dropdown-trigger" id="tag-dropdown-trigger"
            data-active-tag="{{ active_tag|default:'' }}"
            data-search-query="{{ search_query|default:'' }}"
            data-sort="{{ sort|default:'recent' }}">
            <span class="trigger-label">Filter by tag:</span>
            <span class="trigger-value">{% if active_tag %}#{{ active_tag }}{% else %}All{% endif %}</span>
            <svg class="trigger-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </button>
        <div class="tag-dropdown-menu" id="tag-dropdown-menu" style="display: none;">
            <div class="tag-search-wrapper">
                <input type="text" class="tag-search-input" id="tag-search-input" placeholder="Search tags...">
            </div>
            <div class="tag-categories-list" id="tag-categories-list">
                <!-- Populated by JS -->
                <div class="tag-loading">Loading tags...</div>
            </div>
        </div>
    </div>

    {% if posts %}
    {% for post in posts %}
    <article class="post-card" data-post-id="{{ post.pk }}">
        <!-- Vote Section Moved to Bottom -->


        <header class="post-header">
            <!-- Title Row -->
            <div class="post-header-top-row">
                <h2 class="post-title-main">{{ post.title }}</h2>
                {% if post.is_flagged %}
                <span class="post-flagged-badge">‚ö†Ô∏è Flagged for review</span>
                {% endif %}
            </div>

            <!-- Meta Row (Author/Time) -->
            <div class="post-meta-row">
                <div class="post-meta-small">
                    {% if post.is_anonymous %}
                    <div class="post-avatar anonymous tiny">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    {% else %}
                    <div class="post-avatar tiny">
                        {% if post.author.profile.avatar %}
                        <img src="{{ post.author.profile.avatar.url }}" alt="{{ post.author.profile.display_name }}"
                            class="avatar-img">
                        {% else %}
                        <div class="avatar-placeholder">{{
                            post.author.profile.display_name|first|default:post.author.username|first|upper }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                    <span class="post-author-small">
                        {% if post.is_anonymous %}
                        Anonymous
                        {% else %}
                        {{ post.author.profile.display_name|default:post.author.username }}
                        {% endif %}
                    </span>
                    <span class="meta-separator">‚Ä¢</span>
                    <span class="post-time-small">{{ post.created_at|smart_date }}</span>
                </div>
            </div>
        </header>

        {% if post.show_crisis_resources %}
        <div class="crisis-resources-box">
            <strong>You're not alone.</strong> If you or someone you know needs support:
            <ul>
                <li>Yale Mental Health &amp; Counseling: <a href="tel:203-432-0290">203-432-0290</a> (24/7)</li>
                <li>Crisis Text Line: Text HOME to 741741</li>
                <li>988 Suicide &amp; Crisis Lifeline: Call or text 988</li>
            </ul>
        </div>
        {% endif %}
        <div class="post-body-content" data-collapsed="true">
            {{ post.body|linebreaks }}
        </div>

        <!-- Bottom Actions Row: Tags + Reply/Flag -->
        <div class="post-bottom-actions reddit-style-actions">
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <!-- Vote Pill -->
                <div class="action-pill vote-pill">
                    {% with user_vote=user_votes|get_item:post.pk %}
                    <button
                        class="vote-btn upvote {% if user_vote and user_vote.vote_type == 'UPVOTE' %}active{% endif %}"
                        data-post-id="{{ post.pk }}" data-vote-type="UPVOTE" aria-label="Upvote">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 19V5M5 12l7-7 7 7" />
                        </svg>
                    </button>

                    <span class="vote-score" id="vote-score-{{ post.pk }}">
                        {{ post.score|default:0 }}
                    </span>

                    <button
                        class="vote-btn downvote {% if user_vote and user_vote.vote_type == 'DOWNVOTE' %}active{% endif %}"
                        data-post-id="{{ post.pk }}" data-vote-type="DOWNVOTE" aria-label="Downvote">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 5v14M5 12l7 7 7-7" />
                        </svg>
                    </button>
                    {% endwith %}
                </div>

                <!-- Comment Pill -->
                <button class="action-pill comment-pill" onclick="togglePostComments('{{ post.id }}')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span class="pill-label">{{ post.comments.count }}</span>
                </button>
            </div>

            <!-- Flag/Share Pill (Replacing Badge/Share) -->
            <form method="post" action="{% url 'posting:flag' post.id %}" class="flag-form"
                onsubmit="return confirm('Flag this post as inappropriate?');">
                {% csrf_token %}
                <button type="submit" class="action-pill flag-pill" title="Flag">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                        <line x1="4" y1="22" x2="4" y2="15"></line>
                    </svg>
                </button>
            </form>
        </div>


        {# Comments Section - Hidden by default #}
        <div class="comments-wrapper" id="comments-wrapper-{{ post.pk }}" style="display: none;">
            {% include "posting/components/comments.html" with post=post user_comment_votes=user_comment_votes %}
        </div>
    </article>
    {% endfor %}

    <!-- Pagination Controls -->
    {% if posts.has_other_pages %}
    <div class="pagination">
        <span class="step-links">
            {% if posts.has_previous %}
            <a href="?page={{ posts.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if active_tag %}&tag={{ active_tag }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
                class="pagination-link">Previous</a>
            {% endif %}

            <div class="pagination-select-wrapper">
                <span class="pagination-label">Page</span>
                <select onchange="window.location.href=this.value" class="pagination-select">
                    {% for i in posts.paginator.page_range %}
                    <option
                        value="?page={{ i }}{% if search_query %}&q={{ search_query }}{% endif %}{% if active_tag %}&tag={{ active_tag }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
                        {% if posts.number == i %}selected{% endif %}>
                        {{ i }}
                    </option>
                    {% endfor %}
                </select>
                <span class="pagination-label">of {{ posts.paginator.num_pages }}</span>
            </div>

            {% if posts.has_next %}
            <a href="?page={{ posts.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if active_tag %}&tag={{ active_tag }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
                class="pagination-link">Next</a>
            {% endif %}
        </span>
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        {% if search_query %}
        <p class="empty-state-icon">üîç</p>
        <h3>No posts found</h3>
        <p>No posts match your search for "{{ search_query }}".</p>
        <a href="{% url 'posting:home' %}{% if active_tag %}?tag={{ active_tag }}{% endif %}"
            class="clear-filter-button">
            Clear search
        </a>
        {% elif active_tag %}
        <p class="empty-state-icon">üè∑Ô∏è</p>
        <h3>No posts in this category</h3>
        <p>Be the first to post in {{ active_tag|title }}!</p>
        {% else %}
        <p class="empty-state-icon">üìù</p>
        <h3>No posts yet</h3>
        <p>Be the first to share your thoughts!</p>
        {% endif %}
    </div>
    {% endif %}
</section>
{% endif %}

{% if request.GET.view != 'create' %}
<!-- Floating "Share Your Thought" Button (always visible on Home view) -->
<button id="fab-share-thought" class="fab-share-thought visible" onclick="openPostModal()">
    <span class="fab-icon">‚úçÔ∏è</span>
    <span class="fab-text">Share Your Thought</span>
</button>
{% endif %}

<!-- Post Modal -->
<div id="post-modal" class="post-modal" style="display: none;">
    <div class="post-modal-content">
        <div class="modal-header">
            <h2>Create Post</h2>
            <button class="close-modal" onclick="closePostModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <!-- We will clone the form here via JS or just move it? 
                 Moving it might lose state. Let's just have a second form or move the form element.
                 Actually, moving the form element is safer to preserve the form logic. -->
            <div id="modal-form-container"></div>
        </div>
    </div>
</div>

{% endblock content %}